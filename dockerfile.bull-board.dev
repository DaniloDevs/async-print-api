FROM node:20-alpine

WORKDIR /app

# Criar package.json simples para Bull Board
RUN echo '{"name":"bull-board","version":"1.0.0","dependencies":{"@bull-board/api":"^5.10.0","@bull-board/express":"^5.10.0","express":"^4.18.2","bullmq":"^5.0.0","ioredis":"^5.3.2"}}' > package.json

RUN npm install

# Criar servidor do Bull Board
RUN echo "const express = require('express');\n\
const { createBullBoard } = require('@bull-board/api');\n\
const { BullMQAdapter } = require('@bull-board/api/bullMQAdapter');\n\
const { ExpressAdapter } = require('@bull-board/express');\n\
const { Queue } = require('bullmq');\n\
const Redis = require('ioredis');\n\
\n\
const connection = new Redis({\n\
  host: process.env.REDIS_HOST || 'localhost',\n\
  port: parseInt(process.env.REDIS_PORT || '6379'),\n\
  maxRetriesPerRequest: null,\n\
});\n\
\n\
const printQueue = new Queue('print-queue', { connection });\n\
\n\
const serverAdapter = new ExpressAdapter();\n\
serverAdapter.setBasePath('/admin/queues');\n\
\n\
createBullBoard({\n\
  queues: [new BullMQAdapter(printQueue)],\n\
  serverAdapter: serverAdapter,\n\
});\n\
\n\
const app = express();\n\
app.use('/admin/queues', serverAdapter.getRouter());\n\
\n\
const PORT = process.env.BULL_BOARD_PORT || 3001;\n\
app.listen(PORT, () => {\n\
  console.log('ðŸŽ¯ Bull Board disponÃ­vel em http://localhost:' + PORT + '/admin/queues');\n\
});" > server.js

EXPOSE 3001

CMD ["node", "server.js"]